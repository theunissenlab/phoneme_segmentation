---
title: "Fig5_sup3"
author: "Frederic Theunissen & Lily Xue Gong"
date: "5/28/2022"
  pdf_document: default
html_document: default
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Loading up the depencies

```{r libraries}
library(nnet)   # for multinom()
library(rstatix) # for multinom_test()

library(dplyr)  # for filter()

library(ggplot2) # for the boxplot()
library(ggpubr)

library(lme4) # for lmer
library(kableExtra)

```


## Setting up the data frames 
Here we load the data and generate 3 new data frames to separate wholeBrain, Broca and Temporal Cortex.
Note that we set the diphone as the base level.


```{r dataload thirdOrder vs semantic hemisphere stats, echo=FALSE}

# Read the data for thirdOrder vs semantic
data_hemi_thirdSem <- read.csv("../stats_data/df_perfMean_thirdSem_hemi.csv")

# Clean up
# data_hemi_thirdSem <- na.omit(data_hemi_thirdSem)
data_hemi_thirdSem <- subset(data_hemi_thirdSem, select = -c(X))

# Split into 3 different data frames
dataLC_hemi <- filter(data_hemi_thirdSem, rois != "WB" & rois != "Broca" )
attach(dataLC_hemi)
rois <-factor(rois)
levels(rois) <- c("ACunique", "STG", "STS", "LTCunique")
models <-factor(models)
levels(models) <- c("thirdOrder", "semantic", ordered=TRUE)
detach(dataLC_hemi)

dataWB_hemi <- filter(data_hemi_thirdSem, rois == "WB")
dataWB_hemi <- subset(dataWB_hemi, select = -c(rois))
attach(dataWB_hemi)
models <-factor(models)
levels(models) <- c("thirdOrder", "semantic", ordered=TRUE)
detach(dataWB_hemi)


dataBroca_hemi <- filter(data_hemi_thirdSem, rois == "Broca")
dataBroca_hemi <- subset(dataBroca_hemi, select = -c(rois))
attach(dataBroca_hemi)
models <-factor(models)
levels(models) <- c("thirdOrder", "semantic", ordered=TRUE)
detach(dataBroca_hemi)

```

## If semantic perf is statistically different across left vs right hemisphere in WB, and other ROI:

## conclusion: NO

```{r third order simple comparison through different ROIs}

# Clean up
data_hemi_thirdSem <- na.omit(data_hemi_thirdSem)
# data_hemi_thirdSem <- subset(data_hemi_thirdSem, select = -c(X))

rois_names <- unique(data_hemi_thirdSem$rois)
manual_p_adjust_coefficient <-  length(rois_names)


for (r in rois_names){
  print(r)
  data_sub_hemi <- filter(data_hemi_thirdSem, rois == r & models == "semantic")
  data_sub_hemi <- subset(data_sub_hemi, select = -c(rois))
  attach(data_sub_hemi)
  models <-factor(models)
  levels(models) <- c("thirdOrder",ordered=TRUE)
  detach(data_sub_hemi)
  
  model_thirdOrder_hemi_full <- lmer (performance ~ hemis + (1 | subjects), data_sub_hemi)
  model_thirdOrder_noInt <- lmer (performance ~ 1 + (1 | subjects), data_sub_hemi)
  
  a_thirdOrder_hemis<-anova(model_thirdOrder_hemi_full, model_thirdOrder_noInt, p.adj = "bonf")
  
  print(sprintf('Likelihood Ratio Test  left  vs right hemi in %s: ChiSq(%d) = %.2f p=%.2g (manual adjusted p=%.2g)', r, a_thirdOrder_hemis$Df[2], a_thirdOrder_hemis$Chisq[2], a_thirdOrder_hemis$Pr[2], a_thirdOrder_hemis$Pr[2]*manual_p_adjust_coefficient))
}


```


## Phonemic representation hemipheric difference

```{r phonemic representation: left vs right, echo=FALSE}


# Split into 3 different data frames
dataHemi_thirdOrder <- filter(data_hemi_thirdSem, models == "thirdOrder")
attach(dataHemi_thirdOrder)
rois <-factor(rois)
levels(rois) <- c("ACunique", "STG", "STS", "LTCunique", "Broca", "WB")
detach(dataHemi_thirdOrder)


bxp <-
  ggboxplot(
    dataHemi_thirdOrder, x = "rois", y = "performance",
    color = "hemis",
    palette = "jco")
bxp

model_thirdOrder <- lmer (performance ~ rois + hemis + (1 | subjects), dataHemi_thirdOrder)
model_thirdOrder_noHemi <- lmer (performance ~ rois + (1 | subjects), dataHemi_thirdOrder)

a_thirdSem_hemis<-anova(model_thirdOrder, model_thirdOrder_noHemi, p.adj = "bonf")

print(sprintf('Likelihood Ratio Test for hemisphere: ChiSq(%d) = %.2f p=%.2g', a_thirdSem_hemis$Df[2], a_thirdSem_hemis$Chisq[2], a_thirdSem_hemis$Pr[2]))

```



## Semantic representation hemipheric difference

```{r semantic representation: left vs right, echo=FALSE}


# Split into 3 different data frames
dataHemi_sem <- filter(data_hemi_thirdSem, models == "semantic")
attach(dataHemi_sem)
rois <-factor(rois)
levels(rois) <- c("ACunique", "STG", "STS", "LTCunique", "Broca", "WB")
detach(dataHemi_sem)


bxp <-
  ggboxplot(
    dataHemi_sem, x = "rois", y = "performance",
    color = "hemis",
    palette = "jco")
bxp

model_sem <- lmer (performance ~ rois + hemis + (1 | subjects), dataHemi_sem)
model_sem_noHemi <- lmer (performance ~ rois + (1 | subjects), dataHemi_sem)

a_sem_hemis<-anova(model_sem, model_sem_noHemi, p.adj = "bonf")

print(sprintf('Likelihood Ratio Test for hemisphere: ChiSq(%d) = %.2f p=%.2g', a_sem_hemis$Df[2], a_sem_hemis$Chisq[2], a_sem_hemis$Pr[2]))

```


## Whole Brain

```{r Whole Brain third vs sem, echo=FALSE}

bxp <-
  ggboxplot(
    dataWB_hemi, x = "hemis", y = "performance",
    color = "models", color_order = c("thirdOrder", "semantic"),
    palette = "jco")
bxp

model_thirdSem_hemi_full <- lmer (performance ~ models*hemis + (1 | subjects), dataWB_hemi)
model_thirdSem_noInt <- lmer (performance ~ models + hemis + (1 | subjects), dataWB_hemi)

a_thirdSem_hemis<-anova(model_thirdSem_hemi_full, model_thirdSem_noInt, p.adj = "bonf")

print(sprintf('Likelihood Ratio Test for hemisphere across whole cortex: ChiSq(%d) = %.2f p=%.2g', a_thirdSem_hemis$Df[2], a_thirdSem_hemis$Chisq[2], a_thirdSem_hemis$Pr[2]))

```

## Broca area

```{r Broca area third vs sem, echo=FALSE}

bxp <-
  ggboxplot(
    dataBroca_hemi, x = "hemis", y = "performance",
    color = "models", color_order = c("thirdOrder", "semantic"),
    palette = "jco")
bxp

model_thirdSem_hemiBA_full <- lmer (performance ~ models*hemis + (1 | subjects), dataBroca_hemi)
model_thirdSem_noIntBA <- lmer (performance ~ models + hemis + (1 | subjects), dataBroca_hemi)

a_thirdSem_hemisBA<-anova(model_thirdSem_hemiBA_full, model_thirdSem_noIntBA, p.adj = "bonf")

print(sprintf('Likelihood Ratio Test for hemisphere across Broca area: ChiSq(%d) = %.2f p=%.2g', a_thirdSem_hemisBA$Df[2], a_thirdSem_hemisBA$Chisq[2], a_thirdSem_hemisBA$Pr[2]))

```

##  Temporal Cortex

```{r  temporal cortex third vs sem, echo=FALSE}

bxp <-
  ggboxplot(
    dataLC_hemi, x = "rois", y = "performance",
    color = "hemis", color_order = c("thirdOrder", "semantic"),
    shape = "models",
    palette = "jco")
bxp


model_thirdSem_full <- lmer (performance ~ rois*models*hemis + (1 | subjects), dataLC_hemi)
model_thirdSem_noHemi <- lmer (performance ~ rois + models + hemis + rois*models + (1 | subjects), dataLC_hemi)

a_thirdSem_hemi_TC<-anova(model_thirdSem_full, model_thirdSem_noHemi, p.adj = "bonf")

print(sprintf('Likelihood Ratio Test for hemisphere across temporal cortex: ChiSq(%d) = %.2f p=%.2g', a_thirdSem_hemi_TC$Df[2], a_thirdSem_hemi_TC$Chisq[2], a_thirdSem_hemi_TC$Pr[2]))

```

## AC in  Temporal Cortex

```{r AC third vs sem, echo=FALSE}

dataAC_hemi <- filter(data_hemi_thirdSem, rois == "ACunique")
dataAC_hemi <- subset(dataAC_hemi, select = -c(rois))
attach(dataAC_hemi)
models <-factor(models)
levels(models) <- c("thirdOrder", "semantic", ordered=TRUE)
detach(dataAC_hemi)

bxp <-
  ggboxplot(
    dataAC_hemi, x = "hemis", y = "performance",
    color = "models", color_order = c("thirdOrder", "semantic"),
    palette = "jco")
bxp


model_thirdSem_hemiAC_full <- lmer (performance ~ models*hemis + (1 | subjects), dataAC_hemi)
model_thirdSem_noIntAC <- lmer (performance ~ models + hemis + (1 | subjects), dataAC_hemi)

a_thirdSem_hemisAC<-anova(model_thirdSem_hemiAC_full, model_thirdSem_noIntAC, p.adj = "bonf")

print(sprintf('Likelihood Ratio Test for hemisphere across primary auditory area: ChiSq(%d) = %.2f p=%.2g', a_thirdSem_hemisAC$Df[2], a_thirdSem_hemisAC$Chisq[2], a_thirdSem_hemisAC$Pr[2]))
```

## STG in  Temporal Cortex

```{r STG third vs sem, echo=FALSE}

dataSTG_hemi <- filter(data_hemi_thirdSem, rois == "STG")
dataSTG_hemi <- subset(dataSTG_hemi, select = -c(rois))
attach(dataSTG_hemi)
models <-factor(models)
levels(models) <- c("thirdOrder", "semantic", ordered=TRUE)
detach(dataSTG_hemi)

bxp <-
  ggboxplot(
    dataSTG_hemi, x = "hemis", y = "performance",
    color = "models", color_order = c("thirdOrder", "semantic"),
    palette = "jco")
bxp

model_thirdSem_hemiSTG_full <- lmer (performance ~ models*hemis + (1 | subjects), dataSTG_hemi)
model_thirdSem_noIntSTG <- lmer (performance ~ models + hemis + (1 | subjects), dataSTG_hemi)

a_thirdSem_hemisSTG<-anova(model_thirdSem_hemiSTG_full, model_thirdSem_noIntSTG, p.adj = "bonf")

print(sprintf('Likelihood Ratio Test for hemisphere across STG: ChiSq(%d) = %.2f p=%.2g', a_thirdSem_hemisSTG$Df[2], a_thirdSem_hemisSTG$Chisq[2], a_thirdSem_hemisSTG$Pr[2]))

```

## STS in TC

```{r STS third vs sem, echo=FALSE}

dataSTS_hemi <- filter(data_hemi_thirdSem, rois == "STS")
dataSTS_hemi <- subset(dataSTS_hemi, select = -c(rois))
attach(dataSTS_hemi)
models <-factor(models)
levels(models) <- c("thirdOrder", "semantic", ordered=TRUE)
detach(dataSTS_hemi)

bxp <-
  ggboxplot(
    dataSTS_hemi, x = "hemis", y = "performance",
    color = "models", color_order = c("thirdOrder", "semantic"),
    palette = "jco")
bxp


model_thirdSem_hemiSTS_full <- lmer (performance ~ models*hemis + (1 | subjects), dataSTS_hemi)
model_thirdSem_noIntSTS <- lmer (performance ~ models + hemis + (1 | subjects), dataSTS_hemi)

a_thirdSem_hemisSTS<-anova(model_thirdSem_hemiSTS_full, model_thirdSem_noIntSTS, p.adj = "bonf")

print(sprintf('Likelihood Ratio Test for hemisphere across STS: ChiSq(%d) = %.2f p=%.2g', a_thirdSem_hemisSTS$Df[2], a_thirdSem_hemisSTS$Chisq[2], a_thirdSem_hemisSTS$Pr[2]))
```

## LTC in  Temporal Cortex

```{r LTC third vs sem, echo=FALSE}

dataLTCunique_hemi <- filter(data_hemi_thirdSem, rois == "LTCunique")
dataLTCunique_hemi <- subset(dataLTCunique_hemi, select = -c(rois))
attach(dataLTCunique_hemi)
models <-factor(models)
levels(models) <- c("thirdOrder", "semantic", ordered=TRUE)
detach(dataLTCunique_hemi)

bxp <-
  ggboxplot(
    dataLTCunique_hemi, x = "hemis", y = "performance",
    color = "models", color_order = c("thirdOrder", "semantic"),
    palette = "jco")
bxp


model_thirdSem_hemiLTCunique_full <- lmer (performance ~ models*hemis + (1 | subjects), dataLTCunique_hemi)
model_thirdSem_noIntLTCunique <- lmer (performance ~ models + hemis + (1 | subjects), dataLTCunique_hemi)

a_thirdSem_hemisLTCunique<-anova(model_thirdSem_hemiLTCunique_full, model_thirdSem_noIntLTCunique, p.adj = "bonf")

print(sprintf('Likelihood Ratio Test for hemisphere across LTC: ChiSq(%d) = %.2f p=%.2g', a_thirdSem_hemisLTCunique$Df[2], a_thirdSem_hemisLTCunique$Chisq[2], a_thirdSem_hemisLTCunique$Pr[2]))

```





## Posthoc test for each ROI: report this on paper

```{r posthoc test for each ROI: thirdOrder vs semantic}
rois_name_thirdSem <- unique(data_hemi_thirdSem$rois)
nrois_thirdSem <- length(rois_name_thirdSem)

hemi_name_thirdSem <- unique(data_hemi_thirdSem$hemis)
nhemi_thirdSem <- length(hemi_name_thirdSem)

manual_p_adjust_coefficient <-  nrois_thirdSem*12

for (irois_thirdSem in 1:nrois_thirdSem) {
   print(rois_name_thirdSem[irois_thirdSem])
  for (ihemi_thirdSem in 1:nhemi_thirdSem){
   
    data_sub_third <- filter(data_hemi_thirdSem, rois == rois_name_thirdSem[irois_thirdSem] & hemis == hemi_name_thirdSem[ihemi_thirdSem] & data_hemi_thirdSem$models=="thirdOrder")
    data_sub_sem <- filter(data_hemi_thirdSem, rois == rois_name_thirdSem[irois_thirdSem] & hemis == hemi_name_thirdSem[ihemi_thirdSem] & data_hemi_thirdSem$models=="semantic")
    
    res <- t.test(data_sub_third$performance, data_sub_sem$performance, paired = TRUE, p.adjust.method = "bonferroni")
    
    print(sprintf('      Hemi %s region %s: t(%d)= %.2f (p=%.2g, manual adjusted p=%.2g)',  hemi_name_thirdSem[ihemi_thirdSem], rois_name_thirdSem[irois_thirdSem], res$parameter[[1]], res$statistic, res$p.value,res$p.value * manual_p_adjust_coefficient))
  }
}

```

## Did not use/report this

```{r posthoc test for each ROI: thirdOrder vs semantic mean over subject}
rois_name_thirdSem <- unique(data_hemi_thirdSem$rois)
nrois_thirdSem <- length(rois_name_thirdSem)

hemi_name_thirdSem <- unique(data_hemi_thirdSem$hemis)
nhemi_thirdSem <- length(hemi_name_thirdSem)

subj_name_thirdSem <- unique(data_hemi_thirdSem$subjects)
nsubj_thirdSem <- length(subj_name_thirdSem)

manual_p_adjust_coefficient <-  nrois_thirdSem*12

for (irois_thirdSem in 1:nrois_thirdSem) {
   print(rois_name_thirdSem[irois_thirdSem])
  for (ihemi_thirdSem in 1:nhemi_thirdSem){
    subj_third_mean_sum <- array(dim=c(nsubj_thirdSem))
    subj_sem_mean_sum <- array(dim=c(nsubj_thirdSem))
    for (isubj_thirdSem in 1: nsubj_thirdSem){
      subj_third_mean_sum[isubj_thirdSem] <- mean(na.omit(filter(data_hemi_thirdSem, rois == rois_name_thirdSem[irois_thirdSem] & hemis == hemi_name_thirdSem[ihemi_thirdSem]  & data_hemi_thirdSem$subjects==subj_name_thirdSem[isubj_thirdSem]  & data_hemi_thirdSem$models=="thirdOrder" )$performance))
      subj_sem_mean_sum[isubj_thirdSem] <- mean(na.omit(filter(data_hemi_thirdSem, rois == rois_name_thirdSem[irois_thirdSem] & hemis == hemi_name_thirdSem[ihemi_thirdSem]  & data_hemi_thirdSem$subjects==subj_name_thirdSem[isubj_thirdSem]  & data_hemi_thirdSem$models=="semantic" )$performance))
    }
    res <- t.test(subj_third_mean_sum, subj_sem_mean_sum, paired = TRUE, p.adjust.method = "bonferroni")
    
    print(sprintf('      Hemi %s region %s averaged over subject first: t(%d)= %.2f (p=%.2g, manual adjusted p=%.2g)',  hemi_name_thirdSem[ihemi_thirdSem], rois_name_thirdSem[irois_thirdSem], res$parameter[[1]], res$statistic, res$p.value,res$p.value * manual_p_adjust_coefficient))
  }
}

```


```{r dprime calc: single vs diphone vs  triphone, echo=FALSE}


dprime_sum <- array(0, dim=c(nrois_thirdSem, 2))
dprime_sem <- array(0, dim=c(nrois_thirdSem, 2))

for (ihemi_thirdSem in 1:nhemi_thirdSem){
  for (irois_thirdSem in 1:nrois_thirdSem) {
    
    data_sub <- filter(data_hemi_thirdSem, rois == rois_name_thirdSem[irois_thirdSem] & hemis == hemi_name_thirdSem[ihemi_thirdSem])
    data_sub <- subset(data_sub, select = -c(rois))
    attach(data_sub)
    models <-factor(models)
    levels(models) <- c("thirdOrder", "semantic", ordered=TRUE)
    detach(data_sub)
    
    model_thirdSem_features <- lmer (performance ~ models + (1 | subjects), data_sub)
    model_thirdSem_features_summary <- summary(model_thirdSem_features)
    
    pred_std <- as.data.frame(model_thirdSem_features_summary$varcor)$sdcor[1]
    pred_diff <- as.data.frame(model_thirdSem_features_summary$coefficients)$Estimate[2]
    pred_se <- as.data.frame(model_thirdSem_features_summary$coefficients)$Std[2]
    
    dprime_sum[irois_thirdSem, ihemi_thirdSem] <- pred_diff/pred_std
    dprime_sem[irois_thirdSem, ihemi_thirdSem] <- pred_se/pred_std
  
    print(sprintf('Cohen dprime for thirdOrder vs semantic  for %s for %s:  %.3f +- %.3f', rois_name_thirdSem[irois_thirdSem],  hemi_name_thirdSem[ihemi_thirdSem], -dprime_sum[irois_thirdSem, ihemi_thirdSem], 2*dprime_sem[irois_thirdSem, ihemi_thirdSem]))
  
  }
}


```





```{r Individual summary table generation sem vs thirdOrder, echo=FALSE}
subject.names <- unique(data_hemi_thirdSem$subjects)
rois_name <- unique(data_hemi_thirdSem$rois)
hemis_name <- unique(data_hemi_thirdSem$hemis)
nrois <- length(rois_name)
nsubjects <- length(subject.names)
sem_mean <- array(dim=c(nsubjects, nrois, 2))
third_mean <- array(dim=c(nsubjects, nrois, 2))
dprime_ind <- array(dim=c(nsubjects, nrois, 2))

i <- 1
for (sname in subject.names) {
  for (irois in 1:nrois) {
    for (ihemis in 1:2){
      data.subject <- data_hemi_thirdSem[data_hemi_thirdSem$subjects==sname & data_hemi_thirdSem$rois==rois_name[irois] & data_hemi_thirdSem$hemis == hemis_name[ihemis], ]
    sem_mean[i,irois,ihemis] <- mean(data.subject[data.subject$models == "semantic",]$performance)
    third_mean[i,irois,ihemis] <- mean(data.subject[data.subject$models == "thirdOrder",]$performance)
    std_tmp <- sd(data.subject[data.subject$models == "semantic",]$performance - data.subject[data.subject$models == "thirdOrder",]$performance)
    dprime_ind[i,irois,ihemis] <- (sem_mean[i,irois,ihemis] - third_mean[i,irois,ihemis])/std_tmp
    }
  }
  i <- i + 1
}

subjectTable <- data.frame(subject=1:nsubjects, 
                           AC_thirdMean_left=third_mean[,2,1], AC_semMean_left=sem_mean[,2,1],
                           AC_dprime_left=dprime_ind[,2,1], 
                           AC_thirdMean_right=third_mean[,2,2], AC_semMean_right=sem_mean[,2,2],
                           AC_dprime_right=dprime_ind[,2,2], 
                           STG_thirdMean_left=third_mean[,3,1], STG_semMean_left=sem_mean[,3,1],
                           STG_dprime_left=dprime_ind[,3,1], 
                           STG_semMean_right=sem_mean[,3,2],STG_thirdMean_right=third_mean[,3,2],
                           STG_dprime_right=dprime_ind[,3,2], 
                           STS_thirdMean_left=third_mean[,4,1],  STS_semMean_left=sem_mean[,4,1],
                           STS_dprime_left=dprime_ind[,4,1], 
                           STS_thirdMean_right=third_mean[,4,2],STS_semMean_right=sem_mean[,4,2],
                           STS_dprime_right=dprime_ind[,4,2], 
                           LTC_thirdMean_left=third_mean[,5,1], LTC_semMean_left=sem_mean[,5,1],
                           LTC_dprime_left=dprime_ind[,5,1], 
                           LTC_thirdMean_right=third_mean[,5,2],LTC_semMean_right=sem_mean[,5,2],
                           LTC_dprime_right=dprime_ind[,5,2],
                           Broca_thirdMean_left=third_mean[,6,1],Broca_semMean_left=sem_mean[,6,1],
                           Broca_dprime_left=dprime_ind[,6,1],
                           Broca_thirdMean_right=third_mean[,6,2],Broca_semMean_right=sem_mean[,6,2],
                           Broca_dprime_right=dprime_ind[,6,2],
                           WB_thirdMean_left=third_mean[,1,1], WB_semMean_left=sem_mean[,1,1],
                           WB_dprime_left=dprime_ind[,1,1],
                           WB_thirdMean_right=third_mean[,1,2],WB_semMean_right=sem_mean[,1,2],
                           WB_dprime_right=dprime_ind[,1,2]
                           )

#kable(subjectTable, caption=" Mean prediction performance across subjects and brain regions", format.args=list(digits = 1))

kable(subjectTable[,c(1,2,3,4,5,6,7,8,9,10)], caption="Mean prediction performance across subjects, brain regions and hemiphere: Semantic model VS third order phonemic model ", format.args=list(digits = 2))

kable(subjectTable[,c(1,11,12,13,14,15,16,17,18,19)], caption="Mean prediction performance across subjects,  brain regions and hemiphere: Semantic model VS third order phonemic model ", format.args=list(digits = 2))

kable(subjectTable[,c(1,20, 21,22,23,24,25,26,27,28)], caption="Mean prediction performance across subjects,  brain regions and hemiphere: Semantic model VS third order phonemic model ", format.args=list(digits = 2))

kable(subjectTable[,c(1,29,30, 31,32,33,34,35,36,37)], caption="Mean prediction performance across subjects,  brain regions and hemiphere: Semantic model VS third order phonemic model ", format.args=list(digits = 2))

```
